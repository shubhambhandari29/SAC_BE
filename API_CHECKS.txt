
/login

{
  "email": "akshat.gupta@dummy.com",
  "password": "12345678"
}

response :


{
  "message": "Sign in successful",
  "user": {
    "id": 1001,
    "first_name": "Akshat",
    "last_name": "Gupta",
    "email": "akshat.gupta@dummy.com",
    "role": "Underwriter"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTAwMSwiZmlyc3RfbmFtZSI6IkFrc2hhdCIsImxhc3RfbmFtZSI6Ikd1cHRhIiwiZW1haWwiOiJha3NoYXQuZ3VwdGFAZHVtbXkuY29tIiwicm9sZSI6IlVuZGVyd3JpdGVyIiwiZXhwIjoxNzY1MjkzMDE3LCJ1c2VyIjp7ImlkIjoxMDAxLCJmaXJzdF9uYW1lIjoiQWtzaGF0IiwibGFzdF9uYW1lIjoiR3VwdGEiLCJlbWFpbCI6ImFrc2hhdC5ndXB0YUBkdW1teS5jb20iLCJyb2xlIjoiVW5kZXJ3cml0ZXIifX0.CWmLgVxm9KiWcNi02c_IDaABi3pC7d21bUuBeuFwndA"
}



/auth/me : GET

response :

{
  "message": "User authenticated",
  "user": {
    "id": 1,
    "first_name": "Test",
    "last_name": "User",
    "email": "test@example.com",
    "role": "admin"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZmlyc3RfbmFtZSI6IlRlc3QiLCJsYXN0X25hbWUiOiJVc2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwicm9sZSI6ImFkbWluIiwiZXhwIjoxNzY0MTk4MjQxLCJ1c2VyIjp7ImlkIjoxLCJmaXJzdF9uYW1lIjoiVGVzdCIsImxhc3RfbmFtZSI6IlVzZXIiLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJyb2xlIjoiYWRtaW4ifX0.7iRf_aMnPfy-ZwpY0e0paH6nsLqHlv2wLsR5wx-8c2E"
}

http://127.0.0.1:8000/auth/logout

{
  "message": "Logged out successfully"
}


------------------------

GET /sac_account/

Response :

[
  {
    "CustomerNum": "CUST001",
    "CustomerName": "Acme Corp",
    "OnBoardDate": null,
    "ServLevel": "Gold",
    "Stage": "user",
    "isSubmitted": true,
    "AcctOwner": "Alice"
  },
  {
    "CustomerNum": "CUST002",
    "CustomerName": "Acme Corp",
    "OnBoardDate": null,
    "ServLevel": "Gold",
    "Stage": "admin",
    "isSubmitted": true,
    "AcctOwner": "Alice"
  }
]


/sac_account/upsert

Request :

{
  "CustomerNum": "0006952398",
  "CustomerName": "Hub City Ford",
  "OnBoardDate": "2010-03-17",
  "ServLevel": "3.Essential",
  "Stage": "Admin",
  "isSubmitted": "1",
  "AcctOwner": "Marc De Luca",
"BusinessType":"Special Account"

}

Response :

{
  "message": "Transaction successful",
  "count": 1
}


---------------------------

GET /sac_policies

[
  {
    "CustomerNum": "CUST001",
    "PolicyNum": "POL001",
    "PolMod": "00",
    "ServLevel": "Gold",
    "Stage": null,
    "AcctOwner": null,
    "isSubmitted": null,
    "AgentCode": null,
    "AgentName": null,
    "AccountName": null,
    "InceptDate": null,
    "AcctOnPolicyName": null
  }
]

/sac_policies/upsert

Request

{
  "CustomerNum": "1508385396",
  "PolicyNum": "9671764",
  "PolMod": "01",
  "AccountActiveYN": "N",
  "AccountName": "No",
  "AcctOnPolicyName": "Arba Inc The",
  "PremiumAmt": "8608.00",
  "PolicyType": "General liability",
  "AgentCode": "1606177",
  "AgentName": "MCGRIFF SEIBELS WILLIAMS",
  "InceptDate": "2013-07-01"
}

Response :

{
  "message": "Transaction successful",
  "count": 1
}

/sac_policies/update_field_for_all_policies


request :

{
  "fieldName": "AccountName",
  "fieldValue": "yes",
  "updateVia": "CustomerNum",
  "updateViaValue": "1508385396"
}


response :

{
  "message": "Update successful"
}


-----------------------------------------------------------------------------


/search_sac_account/search_by="policyNum"

response :

[
  {
    "Policy Number": "POL001",
    "Customer Number": "CUST002",
    "Customer Name": "Acme Corp",
    "On Board Date": null,
    "Service Level": "Gold"
  }
]


-----------------------------------------------------

/GET /loss_run_distribution

response :


[
  {
    "CustomerNum": "CUST001",
    "EMailAddress": "lossrun@acme.com"
  }
]

 /loss_run_distribution/upsert

 request :

 [
  {
    "CustomerNum": "1111222",
    "RecipCat": "abcccc",
    "DistVia": "xyz",
    "EmailAddress": "user@example.com"
  }
]


response : 

{
  "message": "Transaction successful",
  "count": 1
}


/loss_run_distribution/delete

request:

 [
  {
    "CustomerNum": "1111222",
    "RecipCat": "abcccc",
    "DistVia": "xyz",
    "EMailAddress": "user@example.com",
    "additionalProp1": {}
  }
]


response :

{
  "message": "Deletion successful",
  "count": 1
}



GET /claim_review_distribution

response :

[
  {
    "CustomerNum": "CUST001",
    "EMailAddress": "claims@example.com",
    "RecipientName": "Claims Team"
  },
  {
    "CustomerNum": "CUST002",
    "EMailAddress": "manager@example.com",
    "RecipientName": "Account Manager"
  }
]

/claim_review_distribution/upsert

request :

 [
  {
    "CustomerNum": "1501929738",
    "RecipCat": "Director-Claims Agency Relationssss",
    "DistVia": "Email",
"AttnTo":"Sharon Carruth",

    "EMailAddress": "scarruth@hanover.com"
  }
]


response :

{
  "message": "Transaction successful",
  "count": 1
}

POST /claim_review_distribution/delete

request :

 [
  {
    "CustomerNum": "1501929738",
    "RecipCat": "Director-Claims Agency Relationssss",
    "DistVia": "Email",
"AttnTo":"Sharon Carruth",

    "EMailAddress": "scarruth@hanover.com"
  }
]


response :

{
  "message": "Transaction successful",
  "count": 1
}


GET /deduct_bill_distribution

response:

[
  {
    "CustomerNum": "CUST001",
    "EMailAddress": "claims@example.com"
  },
  {
    "CustomerNum": "CUST002",
    "EMailAddress": "manager@example.com"
  }
]

/deduct_bill_distribution/upsert

request :

[
  {
    "CustomerNum": "1502638683",
    "RecipCat": "Agent",
    "DistVia": "Email",
    "AttnTo": "Eric Myers",
    "EMailAddress": "eric.myers@bbandt.com"
  }
]


response :

{
  "message": "Transaction successful",
  "count": 1
}

POST /deduct_bill_distribution/delete

request :

[
  {
    "CustomerNum": "1507830365",
    "RecipCat": "Agentss",
    "DistVia": "Emailss",
    "AttnTo": "Eric Myersss",
    "EMailAddress": "eric.myers@bbandt.com"
  }
]

response :

{
  "message": "Transaction successful",
  "count": 1
}


GET /loss_run_frequency

response :

[
  {
    "CustomerNum": "CUST001",
    "MthNum": 1,
    "Frequency": 12
  }
]

POST /loss_run_frequency/upsert

Request :

[
  {
    "CustomerNum": "111",
    "MthNum": 1,
    "RptMth": 7,
    "CompDate": "2025-12-10",
    "RptType": "string",
    "DelivMeth": "string"
  }
]

response :

{
  "message": "Transaction successful",
  "count": 2
}

GET /deduct_bill_frequency

response :

[
  {
    "CustomerNum": "CUST001",
    "MthNum": 1,
    "Frequency": 12
  }
]

POST /deduct_bill_frequency/upsert

Request :

[
  {
    "CustomerNum": "1111",
    "MthNum": 1,
    "RptMth": 2
  }
]

response :

{
  "message": "Transaction successful",
  "count": 2
}


GET /claim_review_frequency

response :

[
  {
    "CustomerNum": "CUST001",
    "MthNum": 1,
    "Frequency": 3
  },
  {
    "CustomerNum": "CUST002",
    "MthNum": 1,
    "Frequency": 4
  },
  {
    "CustomerNum": "CUST001",
    "MthNum": 2,
    "Frequency": 1
  },
  {
    "CustomerNum": "CUST002",
    "MthNum": 3,
    "Frequency": 2
  }
]

POST /claim_review_frequency/upsert

Request :

[
  {
    "CustomerNum": "1111",
    "MthNum": 1,
    "RptMth": 0,
    "CompDate": "2025-12-10",
    "RptType": "string",
    "DelivMeth": "string",
    "CRNumNarr": 8
  }
]

response :

{
  "message": "Transaction successful",
  "count": 2
}



/HCM USERS GET

response :

[
  {
    "UserID": "user-1",
    "FirstName": "Jane",
    "LastName": "Doe",
    "Email": "jane@example.com",
    "Role": "Manager",
    "CustomerNum": "CUST001"
  },
  {
    "UserID": "user-2",
    "FirstName": "John",
    "LastName": "Smith",
    "Email": "john@example.com",
    "Role": "Analyst",
    "CustomerNum": "CUST001"
  }
]



POST /hcm_users/upsert 
request :

[
  {
    "CustomerNum": "1511529795",
    "UserID": "tfannin",
    "UserTitle": "Risk Management",
    "UserEmail": "tfanninoud@bellsouth.net"
  }
]

response :

{
  "message": "Transaction successful",
  "count": 1
}



GET /sac_affiliates/
response :

[
  {
    "CustomerNum": "CUST001",
    "AffiliateName": "Acme Health",
    "Email": "contact@acmehealth.com",
    "Phone": "555-0101"
  },
  {
    "CustomerNum": "CUST002",
    "AffiliateName": "Wellness Partners",
    "Email": "info@wellness.com",
    "Phone": "555-0202"
  }
]


/sac_affiliates/upsert
request:

[
  {
    "CustomerNum": "000",
    "AffiliateName": "DUMMY"
  }
]

[
  {
"PK_Number":"333",
    "CustomerNum": "000",
    "AffiliateName": "DUMMY_SUMMY"
  }
]



 /sac_policies/get_premium

 20000


Underwriter
{"CustomerName":"Shubh","CustomerNum":"9999","OnBoardDate":"2025-12-02","AccountNotes":"added account details","DateCreated":"2025-12-22","SAC_Contact2":"Jenna Houle","BranchName":"Midwest - 06 - Northern Michigan Branch","InsuredWebsite":"yess","SHI_Complete":"Yes","CRThresh":50000,"AcctStatus":"Active","HCM_LOC_ONLY":"No","NCMStatus":"Active","NCMStartDt":"2025-12-10","NCMType":"NCM Only","Stage":"Underwriter","IsSubmitted":0,"MarketSegmentation":"demo"}



director::

{"CustomerName":"Shubh","CustomerNum":"9999","BusinessType":"Special Account","OnBoardDate":"2025-12-02","AccountNotes":"added account details","DateCreated":"2025-12-22","SAC_Contact1":"Cyrille Nzouda Tsotezo","SAC_Contact2":"Jenna Houle","LossCtlRep1":"Amy Snetsky","LossCtlRep2":"Anthony Carolei","BranchName":"Midwest - 06 - Northern Michigan Branch","InsuredWebsite":"yess","SHI_Complete":"Yes","HCMAccess":"Discontinued","LossRunDistFreq":"1.Monthly-P-$11 Reserves","DeductDistFreq":"1.Monthly-P-$11 Reserves","ClaimRevDistFreq":"2.Quarterly","AcctOwner":"Harjaspreet Singh","OBMethod":"Remote","CRThresh":50000,"AcctStatus":"Inactive","TermDate":"2025-12-16","TermCode":"Agent Terminated","DateNotif":"2025-12-23","RiskSolMgr":"Andrew Driscoll","HCM_LOC_ONLY":"No","NCMStatus":"Inactive","NCMStartDt":"2025-12-10","NCMType":"First Fill Only","Stage":"Director","IsSubmitted":1,"MarketSegmentation":"demo"}



import logging
from datetime import UTC, datetime, timedelta
from typing import Any

from fastapi import HTTPException, Request, Response

from core.db_helpers import run_raw_query
from core.encrypt import hash_password, verify_password
from core.jwt_handler import (
    ACCESS_TOKEN_VALIDITY,
    create_access_token,
    decode_access_token,
)
from db import db_connection

logger = logging.getLogger(__name__)

SESSION_COOKIE_NAME = "session"
COOKIE_OPTIONS = {
    "httponly": True,
    "secure": False,  # for local test. we will make it True for https envs
    "samesite": "lax",
    "path": "/",
}


def _set_session_cookie(response: Response, token: str) -> None:
    response.set_cookie(
        key=SESSION_COOKIE_NAME,
        value=token,
        max_age=ACCESS_TOKEN_VALIDITY * 60,
        expires=datetime.now(UTC) + timedelta(minutes=ACCESS_TOKEN_VALIDITY),
        **COOKIE_OPTIONS,
    )


def _clear_session_cookie(response: Response) -> None:
    response.delete_cookie(key=SESSION_COOKIE_NAME, path=COOKIE_OPTIONS["path"])


def _persist_hashed_password(user_id: int, new_hash: str) -> None:
    with db_connection() as conn:
        cursor = conn.cursor()
        cursor.execute(
            "UPDATE tblUsers SET password = ? WHERE id = ?",
            (new_hash, user_id),
        )
        conn.commit()


# -------------------------
# DB HELPERS FOR AUTH USER
# -------------------------


def get_user_by_email(email: str) -> dict[str, Any] | None:
    """
    Fetch a single active user by email.
    Returns: dict or None
    """

    query = """
        SELECT *
        FROM tblUsers
        WHERE active = 1 AND email = ?
    """

    try:
        results = run_raw_query(query, [email])
    except Exception as e:
        logger.error(f"DB error fetching user by email {email}: {e}")
        raise

    if len(results) == 1:
        return results[0]

    return None


# -------------------------
# AUTH SERVICE FUNCTIONS
# -------------------------


async def login_user(login_data: dict[str, Any], response: Response):
    """
    Validates user email/password.
    Sets HTTP-only cookie.
    Returns user profile + token.
    """

    email = login_data.get("email")
    password = login_data.get("password")
    if not email or not password:
        logger.warning("Login attempt with missing data")
        raise HTTPException(status_code=400, detail={"error": "Missing email or password"})

    # Fetch user from DB
    user_record = get_user_by_email(email)

    if not user_record:
        logger.warning(f"Login failed: user not found ({email})")
        raise HTTPException(status_code=404, detail={"error": "User not found"})
    stored_password = str(user_record.get("Password", ""))
    password_valid = False
    needs_rehash = False

    try:
        password_valid = verify_password(password, stored_password)
    except ValueError:
        if password == stored_password:
            password_valid = True
            needs_rehash = True
        else:
            password_valid = False

    if not password_valid:
        logger.warning(f"Login failed: wrong password ({email})")
        raise HTTPException(status_code=401, detail={"error": "Wrong password"})

    if needs_rehash:
        try:
            new_hash = hash_password(password)
            _persist_hashed_password(user_record["ID"], new_hash)
            logger.info(f"Rehashed legacy password for user {email}")
        except Exception as exc:
            logger.error(f"Failed to rehash password for user {email}: {exc}", exc_info=True)

    # Prepare user payload (only safe fields)
    user = {
        "id": user_record["ID"],
        "first_name": user_record["FirstName"],
        "last_name": user_record["LastName"],
        "email": user_record["Email"],
        "role": user_record["Role"],
        "branch": user_record["BranchName"],
    }

    # Create JWT
    token = create_access_token(user)

    # Set cookie
    _set_session_cookie(response, token)

    logger.info(f"User {email} logged in successfully")

    return {"message": "Sign in successful", "user": user, "token": token}


async def get_current_user_from_token(request: Request):
    """
    Validates JWT from cookie.
    Returns decoded user.
    """

    token = request.cookies.get(SESSION_COOKIE_NAME)
    if not token:
        raise HTTPException(status_code=401, detail={"error": "Not authenticated"})

    try:
        payload = decode_access_token(token)
        user = payload.get("user")
        if not user:
            raise HTTPException(status_code=401, detail={"error": "Invalid token"})
    except Exception as e:
        logger.error(f"Token decode failed: {e}")
        raise HTTPException(status_code=401, detail={"error": "Invalid token"}) from e

    return {"message": "User authenticated", "user": user, "token": token}


async def logout_user(response: Response):
    """
    Deletes the session cookie.
    """
    _clear_session_cookie(response)
    logger.info("User logged out successfully")
    return {"message": "Logged out successfully"}


async def refresh_user_token(request: Request, response: Response, token: str | None):
    """
    Creates a new token using an existing valid token.
    """

    # If dependency didn't supply token, check cookie
    if not token:
        token = request.cookies.get(SESSION_COOKIE_NAME)

    if not token:
        raise HTTPException(status_code=401, detail={"error": "No token found"})

    try:
        payload = decode_access_token(token)
        user = payload.get("user")
        if not user:
            raise HTTPException(status_code=401, detail={"error": "Invalid token"})
    except Exception as e:
        logger.error(f"Token refresh failed: {e}")
        raise HTTPException(status_code=401, detail={"error": "Invalid token"}) from e

    # Generate new token
    new_token = create_access_token(user)

    _set_session_cookie(response, new_token)

    logger.info(f"Token refreshed for user {user['email']}")

    return {"message": "Token refreshed", "token": new_token}





